# sys-diplom-pks
## Дипломный проект учащейся Политико Ксения

### Описание проекта
Проект представляет собой автоматизированное развертывание инфраструктуры в облаке Яндекс.Облако с использованием современных практик DevOps. В проекте реализована отказоустойчивая архитектура с использованием балансировщика нагрузки, мониторингом через Zabbix и централизованным логированием через Elasticsearch.

### Используемые технологии
- **Infrastructure as Code (IaC)**:
  - Terraform для управления облачной инфраструктурой
  - Ansible для конфигурации и оркестрации
- **Облачная платформа**:
  - Яндекс.Облако
  - Виртуальные машины на базе Ubuntu 22.04 LTS
- **Мониторинг и логирование**:
  - Zabbix 7.0 для мониторинга
  - Elasticsearch для централизованного сбора логов
  - Filebeat для отправки логов
- **Веб-серверы**:
  - Nginx
- **База данных**:
  - PostgreSQL
- **Безопасность**:
  - Bastion-хост для безопасного доступа
  - SSH-ключи для аутентификации
  - Security Groups для контроля доступа

### Структура проекта
```
.
├── ansible/              # Ansible плейбуки и конфигурации
├── cloud-init/          # Cloud-init конфигурации для ВМ
├── scripts/             # Скрипты автоматизации
├── ssh-keys/           # SSH ключи (исключены из git)
└── terraform/          # Terraform конфигурации
```

### Развертывание
Проект содержит все необходимые файлы в текущей директории, в том числе и ключи доступа (вырезаны через gitignore). 
Основной файл - `main.tf`, он разворачивает инфраструктуру в облаке Яндекс.

#### Запуск развертывания
```bash
./scripts/deploy.sh
```

#### Пересоздание проекта
```bash
./scripts/deploy.sh clear
```

### Особенности реализации

#### Ansible
- В один день `ansible.builtin.command: |` (именно с |) у тебя будет работать, в другой посылает лесом. \
  Используй `ansible.builtin.shell: |`

#### Особенность создания БД через ansible
По умолчанию PostgreSQL разрешает доступ только через Unix-сокет с peer-аутентификацией (всякие там login_host тут не работают) поэтому без должной настройки использование встроенных postgres команд не получится. Самый простой вариант оказался выполнить bash команды.

#### Особенности разворачивания Zabbix под Ubuntu 22.04
Дефолтные конфиги с nginx не работают, из коробки оно не заведется. 
Обязательно!
1. Удалить default-сайт `/etc/nginx/sites-enabled/default`

2. Добавить ссылку на наш конфиг, чтобы nginx подхватывал его:
   ```bash
   sudo ln -s /etc/zabbix/nginx.conf /etc/nginx/sites-enabled/zabbix.conf
   ```

3. Раскомментировать в `/etc/zabbix/nginx.conf`:
   - `listen 8080;` и заменить на `listen 80;`
   - `server_name example.com;` и заменить на `server_name IP_ZABBIX;`

4. Закоментировать строку в `/etc/zabbix/nginx.conf` в "location ~ [^/]\.php(/|$) {}":
   ```nginx
   # fastcgi_param   PATH_TRANSLATED /usr/share/zabbix$fastcgi_script_name;
   ```

5. Добавить эту строчку: 
   ```nginx
   fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
   ```

6. Заменить в файле `/etc/zabbix/nginx.conf`:
   ```nginx
   fastcgi_pass    unix:/var/run/php/zabbix.sock;
   ```
   на 
   ```nginx
   fastcgi_pass    unix:/var/run/php/php8.1-fpm.sock;
   ```
   Оказывается! Внезапно для разрабов zabbix что в Ubuntu 22.04 используется версионный сокет php8.1, а не общий zabbix.sock
   Проверить какой используется: `sudo grep -r "listen =" /etc/php/8.1/fpm/`
   Или какой создан: `ls -la /var/run/php/php*.sock`

7. Я разочарована в ansible. Нет, оно работает, но, всегда есть НО. В общем, на мой взгляд лучше не использовать 
   встроенные модули, а тупо делать всё через shell. Больше нервов сохранишь и времени, ну или писать их самой. 
   Оказалось проще записать целый конфиг nginx чем использовать regexp из-под модуля ansible.

### Примечания
- Запуск playbook происходит из bastion
- Обращение к машинам из playbook осуществляется по FQDN, прописанным в hosts bastion
- Все конфигурационные файлы и скрипты документированы и содержат комментарии
  
  